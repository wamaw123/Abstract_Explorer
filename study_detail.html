<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Study Details - View detailed clinical trial abstract information">
    <meta name="author" content="Conference Abstract Explorer">
    <title>Study Details - Conference Abstract Explorer</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link rel="preload" href="explorer_styles.css" as="style">
    <link rel="preload" href="studies_data.js" as="script">
    
    <!-- External resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="explorer_styles.css"> 
    <script src="studies_data.js"></script>
    
    <!-- Enhanced meta tags -->
    <meta name="theme-color" content="#0A2F5C">
    <meta name="msapplication-TileColor" content="#0A2F5C">
    
    <!-- Performance improvements -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//cdn.tailwindcss.com">
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-sobi-teal focus:text-white focus:rounded-md focus:no-underline">
        Skip to main content
    </a>

    <!-- Enhanced header with better accessibility -->
    <header class="main-header py-3" role="banner">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="page-title-container">
                <img src="iconn.png" alt="Conference Abstract Explorer" class="detail-header-icon"> 
                <h1 id="studyPageTitle" class="text-lg sm:text-xl font-semibold tracking-tight truncate" title="Study Details">
                    Study Details
                </h1>
                <button id="favoriteBtnOnDetail" class="favorite-btn" aria-label="Save to favorites" type="button">
                    <svg class="w-6 h-6 heart-empty" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                    </svg>
                    <svg class="w-6 h-6 heart-filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383-.218l-.022.012-.007.004-.004.001a.752.752 0 01-.704 0l-.004-.001z" />
                    </svg>
                </button>
            </div>
            
            <!-- Enhanced navigation with breadcrumb -->
            <nav aria-label="Page navigation" class="flex items-center space-x-2">
                <div class="hidden md:flex items-center space-x-2 text-white/80 text-sm mr-4">
                    <a href="Conference_Explorer.html" class="hover:text-white transition-colors">Explorer</a>
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                    <span class="text-white font-medium">Study Details</span>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button id="addCommentBtn" class="btn btn-comment-selection text-xs" type="button" aria-describedby="add-comment-help">
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Comment
                    </button>
                    <button id="toggleCommentsBtn" class="btn btn-back text-xs" type="button" aria-describedby="toggle-comments-help">
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span id="commentsButtonText">Show Comments</span>
                    </button>
                    <a href="Conference_Explorer.html" class="btn btn-back" role="button" aria-label="Return to abstract explorer">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1.5" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                        </svg>
                        Back to Explorer
                    </a>
                </div>
            </nav>
        </div>
        
        <!-- Help text for screen readers -->
        <div class="sr-only">
            <p id="add-comment-help">Click to open the comments panel and add a new comment</p>
            <p id="toggle-comments-help">Click to show or hide the comments panel</p>
        </div>
    </header>

    <!-- Loading indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-40 flex items-center justify-center" style="display: none;">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-sobi-teal"></div>
            <p class="mt-4 text-sobi-medium-gray-text">Loading study details...</p>
        </div>
    </div>

    <!-- Main content wrapper -->
    <div class="study-detail-main-wrapper">
        <main id="main-content" class="content-wrapper" role="main">
            <!-- Error state -->
            <div id="errorState" class="hidden text-center py-16" role="alert">
                <svg class="mx-auto h-16 w-16 text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.232 8.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
                <h2 class="text-2xl font-semibold text-red-600 mb-4">Error: Abstract Not Found</h2>
                <p class="text-sobi-medium-gray-text mb-6">The requested abstract file could not be loaded. Please return to the explorer and try again.</p> 
                <a href="Conference_Explorer.html" class="btn btn-back inline-block" role="button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1.5" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                    </svg>
                    Return to Explorer
                </a>
            </div>
            
            <!-- Study content iframe -->
            <iframe id="studyFrame" 
                    title="Study Content" 
                    aria-label="Clinical trial abstract content"
                    sandbox="allow-same-origin allow-scripts"
                    style="display: none;">
                <p>Your browser does not support iframes. Please go back and try a different browser.</p>
            </iframe>
        </main>

        <!-- Enhanced comments sidebar -->
        <aside id="commentsSidebar" class="comments-sidebar" role="complementary" aria-label="Comments and annotations">
            <div class="p-4 text-sm text-gray-500">Loading comments...</div>
        </aside>
    </div>

    <!-- Enhanced image lightbox -->
    <div id="imageLightbox" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="lightbox-title">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" aria-hidden="true"></div>
        <div class="relative flex items-center justify-center min-h-screen p-4">
            <button class="lightbox-close absolute top-4 right-4" type="button" aria-label="Close image viewer">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div class="text-center">
                <img class="lightbox-content max-w-full max-h-[80vh] object-contain" id="lightboxImg" alt="">
                <p id="lightboxCaption" class="mt-4 text-white/80 text-sm"></p>
            </div>
        </div>
        <div id="lightbox-title" class="sr-only">Image viewer</div>
    </div>

    <!-- Toast notification container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <!-- Enhanced script loading with error handling -->
    <script>
        // Enhanced error handling and loading states
        window.addEventListener('load', function() {
            const loadTime = performance.now();
            console.log('Study detail page loaded in', Math.round(loadTime), 'ms');
            
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        });
        
        // Add error handling for failed resource loads
        window.addEventListener('error', function(e) {
            console.error('Resource failed to load:', e.target.src || e.target.href);
            
            // Show user-friendly error for iframe loading issues
            if (e.target.id === 'studyFrame') {
                const errorState = document.getElementById('errorState');
                const studyFrame = document.getElementById('studyFrame');
                if (errorState && studyFrame) {
                    errorState.classList.remove('hidden');
                    studyFrame.style.display = 'none';
                }
            }
        });
        
        // Enhanced keyboard navigation
        document.addEventListener('keydown', function(e) {
            // Close lightbox with Escape key
            if (e.key === 'Escape') {
                const lightbox = document.getElementById('imageLightbox');
                if (lightbox && !lightbox.classList.contains('hidden')) {
                    lightbox.classList.add('hidden');
                    const lightboxImg = document.getElementById('lightboxImg');
                    if (lightboxImg) lightboxImg.src = "";
                    document.body.style.overflow = 'auto';
                }
            }
            
            // Toggle comments with keyboard shortcut (Ctrl/Cmd + /)
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                const toggleBtn = document.getElementById('toggleCommentsBtn');
                if (toggleBtn) {
                    toggleBtn.click();
                }
            }
        });
        
        // Enhanced iframe loading with better error handling
        function setupIframeErrorHandling() {
            const iframe = document.getElementById('studyFrame');
            if (!iframe) return;
            
            let loadTimeout = setTimeout(() => {
                console.warn('Iframe loading timeout');
                showLoadingError();
            }, 10000); // 10 second timeout
            
            iframe.addEventListener('load', function() {
                clearTimeout(loadTimeout);
                iframe.style.display = 'block';
                
                // Hide loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            });
            
            iframe.addEventListener('error', function() {
                clearTimeout(loadTimeout);
                showLoadingError();
            });
        }
        
        function showLoadingError() {
            const errorState = document.getElementById('errorState');
            const studyFrame = document.getElementById('studyFrame');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            if (errorState) errorState.classList.remove('hidden');
            if (studyFrame) studyFrame.style.display = 'none';
            if (loadingIndicator) loadingIndicator.style.display = 'none';
        }
        
        // Initialize iframe error handling
        document.addEventListener('DOMContentLoaded', setupIframeErrorHandling);
        
        // Add focus management for better accessibility
        function manageFocusForModal(modalElement, isOpen) {
            if (isOpen) {
                // Store the currently focused element
                modalElement.dataset.previousFocus = document.activeElement;
                
                // Focus the modal
                modalElement.focus();
                
                // Trap focus within modal
                const focusableElements = modalElement.querySelectorAll(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                
                if (focusableElements.length > 0) {
                    focusableElements[0].focus();
                }
            } else {
                // Return focus to previously focused element
                const previousFocus = document.querySelector(`[data-previous-focus]`) || document.body;
                if (previousFocus && previousFocus.focus) {
                    previousFocus.focus();
                }
            }
        }
        
        // Enhanced toast notification system (reused from main page)
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-x-full`;
            
            const bgColors = {
                success: 'bg-green-50 border-green-200',
                error: 'bg-red-50 border-red-200', 
                warning: 'bg-yellow-50 border-yellow-200',
                info: 'bg-blue-50 border-blue-200'
            };

            const iconColors = {
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400', 
                info: 'text-blue-400'
            };

            const icons = {
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.232 8.5c-.77.833.192 2.5 1.732 2.5z"></path>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
            };

            toast.innerHTML = `
                <div class="p-4 ${bgColors[type]} border ${bgColors[type].split(' ')[1]}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 ${iconColors[type]}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                ${icons[type]}
                            </svg>
                        </div>
                        <div class="ml-3 w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button class="inline-flex text-gray-400 hover:text-gray-500 focus:outline-none" onclick="this.closest('.transform').remove()">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            toastContainer.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
                toast.classList.add('translate-x-0');
            }, 100);

            // Auto remove
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        // Make showToast globally available
        window.showToast = showToast;
    </script>
    
    <script defer src="detail_app.js"></script>
</body>
</html>
